<!doctype html><html lang=en data-theme><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer-when-downgrade"><title>Chef without Chef server - (Dev)Ops observations</title><meta name=description content="There are couple alternatives available if you wish to use Chef in your infrastructure, but don&rsquo;t have budget to setup hosted Chef service. So far I&rsquo;ve seen one based on Git and another based on AWS S3."><link rel=icon type=image/x-icon href=http://blog.ylitalot.com/favicon.ico><link rel=apple-touch-icon-precomposed href=http://blog.ylitalot.com/favicon.png><style>body{visibility:hidden;opacity:0}</style><noscript><style>body{visibility:visible;opacity:1}</style></noscript><link rel=stylesheet href=http://blog.ylitalot.com/css/style.min.aac3b3a2a3235d20a652d9ccde7ec59be09f74c45de387513f681d02f3912b95.css integrity="sha256-qsOzoqMjXSCmUtnM3n7Fm+CfdMRd44dRP2gdAvORK5U="><script src=http://blog.ylitalot.com/js/script.min.74bf1a3fcf1af396efa4acf3e660e876b61a2153ab9cbe1893ac24ea6d4f94ee.js type=text/javascript integrity="sha256-dL8aP88a85bvpKzz5mDodrYaIVOrnL4Yk6wk6m1PlO4="></script><meta property="og:title" content="Chef without Chef server"><meta property="og:description" content="There are couple alternatives available if you wish to use Chef in your infrastructure, but don&rsquo;t have budget to setup hosted Chef service. So far I&rsquo;ve seen one based on Git and another based on AWS S3."><meta property="og:type" content="article"><meta property="og:url" content="http://blog.ylitalot.com/post/chef-without-server/"><meta property="article:section" content="post"><meta property="article:published_time" content="2015-09-14T12:00:00+02:00"><meta property="article:modified_time" content="2015-09-14T12:00:00+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Chef without Chef server"><meta name=twitter:description content="There are couple alternatives available if you wish to use Chef in your infrastructure, but don&rsquo;t have budget to setup hosted Chef service. So far I&rsquo;ve seen one based on Git and another based on AWS S3."></head><body><a class=skip-main href=#main>Skip to main content</a><div class=container><header class=common-header><div class=header-top><h1 class=site-title><a href=/>(Dev)Ops observations</a></h1><ul class=social-icons><li><a href=mailto:juha.ylitalo@gmail.com title=Email rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M464 64H48C21.49 64 0 85.49.0 112v288c0 26.51 21.49 48 48 48h416c26.51.0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 4e2V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V4e2H48z"/></svg></span></a></li><li><a href=https://twitter.com/jylitalo title=Twitter rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></span></a></li><li><a href=https://github.com/jylitalo title=Github rel=me><span class=inline-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></a></li></ul></div><nav><a href=http://blog.ylitalot.com/ title>Index</a>
<a href=http://blog.ylitalot.com/about title>About</a></nav></header><main id=main tabindex=-1><article class="post h-entry"><div class=post-header><header><h1 class="p-name post-title">Chef without Chef server</h1></header></div><div class="content e-content"><p>There are couple alternatives available if you wish to use Chef in your infrastructure, but don&rsquo;t have budget to setup hosted Chef service. So far I&rsquo;ve seen one based on Git and another based on AWS S3.</p><h2 id=git-based-solution>Git based solution
<span><a href=#git-based-solution><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h2><p>In git based solution, create repository into bitbucket.com and create directory tree:</p><ul><li>/chef/cookbooks/my_cookbook/definitions/default.rb</li><li>/chef/cookbooks/my_cookbook/files</li><li>/chef/cookbooks/my_cookbook/recipes/default.rb</li></ul><p>In your <em>/chef/cookbooks/my_cookbook/recipes/default.rb</em>, put following text among other stuff:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>directory &#39;/root/bin&#39; do
</span></span><span class=line><span class=cl>  owner &#39;root&#39;
</span></span><span class=line><span class=cl>  group &#39;root&#39;
</span></span><span class=line><span class=cl>  mode &#39;0700&#39;
</span></span><span class=line><span class=cl>  action :create
</span></span><span class=line><span class=cl>end
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cookbook_file &#39;/root/bin/run_chef&#39; do
</span></span><span class=line><span class=cl>  source &#39;run_chef&#39;
</span></span><span class=line><span class=cl>  owner &#39;root&#39;
</span></span><span class=line><span class=cl>  group &#39;root&#39;
</span></span><span class=line><span class=cl>  mode &#39;0700&#39;
</span></span><span class=line><span class=cl>  action :create
</span></span><span class=line><span class=cl>end
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cron &#39;run chef hourly&#39; do
</span></span><span class=line><span class=cl>  minute &#39;13&#39;
</span></span><span class=line><span class=cl>  user &#39;root&#39;
</span></span><span class=line><span class=cl>  home &#39;/root&#39;
</span></span><span class=line><span class=cl>  command &#39;/root/bin/run_chef&#39;
</span></span><span class=line><span class=cl>  action :create
</span></span><span class=line><span class=cl>end
</span></span></code></pre></td></tr></table></div></div><p>Create <em>/chef/cookbooks/my_cookbook/files/run_chef</em>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nb>cd</span> /root/my_repository/chef
</span></span><span class=line><span class=cl>git pull
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> ! -f /etc/chef/client.rb <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  mkdir -p /etc/chef
</span></span><span class=line><span class=cl>  cat &gt; /etc/chef/client.rb <span class=p>&amp;</span>lt<span class=p>;&amp;</span>lt<span class=p>;</span>EOF
</span></span><span class=line><span class=cl>log_level        :info
</span></span><span class=line><span class=cl>log_location     STDOUT
</span></span><span class=line><span class=cl>EOF
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>chef-client -z -c /etc/chef/client.rb -o my_cookbook
</span></span></code></pre></td></tr></table></div></div><p>Now you are ready to commit and push your git repository into bitbucket.</p><p>In client hosts, create ssh keys (without passphrase). Add your public ssh key as deployment key into your new repository. <code>git clone</code> your repository under /root. <code>cd my_repository</code> and <code>chef-client -z -o my_cookbook</code></p><h2 id=s3-based-solution>S3 based solution
<span><a href=#s3-based-solution><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h2><p>Our S3 based solution starts in same fashion with Git based solution. First we create git repository, create directory tree into it and configure cron to run /root/bin/run_chef on hourly basis. Things split into new course in <em>/chef/cookbooks/my_cookbook/files/run_chef</em>. With S3, file content should be:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span>/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
</span></span><span class=line><span class=cl><span class=nb>cd</span> /root/
</span></span><span class=line><span class=cl>rm -rf cookbooks
</span></span><span class=line><span class=cl>aws s3 --no-sign-request cp s3://my_s3_bucket/my_cookbooks.tar.gz .
</span></span><span class=line><span class=cl>tar xzvf cookbooks.tar.gz
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> ! -f /etc/chef/client.rb <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  mkdir -p /etc/chef
</span></span><span class=line><span class=cl>  cat &gt; /etc/chef/client.rb <span class=p>&amp;</span>lt<span class=p>;&amp;</span>lt<span class=p>;</span>EOF
</span></span><span class=line><span class=cl>log_level        :info
</span></span><span class=line><span class=cl>log_location     STDOUT
</span></span><span class=line><span class=cl>EOF
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>chef-client -z -c /etc/chef/client.rb -o my_cookbook
</span></span></code></pre></td></tr></table></div></div><p><em>NOTE:</em> awscli 1.2.9 doesn&rsquo;t support <code>--no-sign-request</code> command line option, so you need something more recent than that. If you install it with <code>pip install awscli</code> in Ubuntu, it will get installed under <em>/usr/local/bin</em>.</p><p>In your <em>/chef/cookbooks/my_cookbook</em> directory, issue <code>berks install</code> and <code>berks package</code>. This should create <em>cookbooks-*.tar.gz</em>. Rename it into <em>cookbook.tar.gz</em>.</p><p>You also need S3 bucket my_s3_bucket with following kind of S3 bucket policy.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>{
</span></span><span class=line><span class=cl>  &#34;Version&#34;: &#34;2012-10-17&#34;,
</span></span><span class=line><span class=cl>  &#34;Statement&#34;: [
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl>      &#34;Sid&#34;: &#34;AddCannedAcl&#34;,
</span></span><span class=line><span class=cl>      &#34;Effect&#34;: &#34;Allow&#34;,
</span></span><span class=line><span class=cl>      &#34;Principal&#34;: {
</span></span><span class=line><span class=cl>          &#34;AWS&#34;: &#34;arn:aws:iam::MY_AWS_ACCOUNT_NUMBER:root&#34;
</span></span><span class=line><span class=cl>      },
</span></span><span class=line><span class=cl>      &#34;Action&#34;: [
</span></span><span class=line><span class=cl>          &#34;s3:GetObjectAcl&#34;,
</span></span><span class=line><span class=cl>          &#34;s3:GetObject&#34;
</span></span><span class=line><span class=cl>      ],
</span></span><span class=line><span class=cl>      &#34;Resource&#34;: &#34;arn:aws:s3:::my_s3_bucket/*&#34;
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  ]
</span></span><span class=line><span class=cl>}
</span></span></code></pre></td></tr></table></div></div><p>Now you are ready to upload your <em>cookbook.tar.gz</em> into my_s3_bucket. Remember to set <em>cookbook.tar.gz</em> public, so that our EC2 instances can access it. Now you just have to copy <em>/chef/cookbooks/my_cookbook/files/run_chef</em> to your instance (for example as part of userdata) and execute it once.</p><h2 id=comparison>Comparison
<span><a href=#comparison><svg viewBox="0 0 28 23" height="100%" width="19" xmlns="http://www.w3.org/2000/svg"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" fill="none" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2"/></svg></a></span></h2><p>In Git based solution, prerequirements are git and chef-client. You have complete audit trail, because all content is pushed through the git repository, but you have to maintain deployment keys (or put one valid deployment keypair into chef configuration, if you want to do autoscaling).</p><p>In S3 based solution, prerequirements are awscli (that supposed &ndash;no-sign-request) and chef-client. You don&rsquo;t have to worry about deployment keys and you can use Berksfile to maintain all your 3rd party cookbooks, but you have to create new cookbook.tar.gz whenever you make changes to your chef configuration and there is no direct linking between your cookbook.tar.gz files and content in git repository.</p><p>Both scenarios work very well, if the goal is to ensure that all your nodes have necessary user accounts, properly configured sudoers and monitoring tools like nagios plugins or zabbix-agent.</p></div><div class=post-info><div class="post-date dt-published">2015-09-14</div><a class="post-hidden-url u-url" href=http://blog.ylitalot.com/post/chef-without-server/>http://blog.ylitalot.com/post/chef-without-server/</a>
<a href=http://blog.ylitalot.com/ class="p-name p-author post-hidden-author h-card" rel=me>Juha Ylitalo</a><div class=post-taxonomies><ul class=post-categories><li><a href=http://blog.ylitalot.com/categories/index/>index</a></li><li><a href=http://blog.ylitalot.com/categories/chef/>chef</a></li><li><a href=http://blog.ylitalot.com/categories/ruby/>ruby</a></li></ul></div></div></article></main><footer class=common-footer><div class=common-footer-bottom><div class=copyright><p>© Juha Ylitalo, 2022<br>Powered by <a target=_blank rel="noopener noreferrer" href=https://gohugo.io/>Hugo</a>, theme <a target=_blank rel="noopener noreferrer" href=https://github.com/mitrichius/hugo-theme-anubis>Anubis</a>.<br></p></div><button class=theme-switcher>
Dark theme</button>
<script>const STORAGE_KEY="user-color-scheme",defaultTheme="auto";let currentTheme,switchButton,autoDefinedScheme=window.matchMedia("(prefers-color-scheme: dark)");const autoChangeScheme=e=>{currentTheme=e.matches?"dark":"light",document.documentElement.setAttribute("data-theme",currentTheme),changeButtonText()};document.addEventListener("DOMContentLoaded",function(){switchButton=document.querySelector(".theme-switcher"),currentTheme=detectCurrentScheme(),currentTheme=="dark"&&document.documentElement.setAttribute("data-theme","dark"),currentTheme=="auto"&&(autoChangeScheme(autoDefinedScheme),autoDefinedScheme.addListener(autoChangeScheme)),switchButton&&(changeButtonText(),switchButton.addEventListener("click",switchTheme,!1)),showContent()});function detectCurrentScheme(){return localStorage.getItem(STORAGE_KEY)?localStorage.getItem(STORAGE_KEY):defaultTheme?defaultTheme:window.matchMedia?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":"light"}function changeButtonText(){switchButton&&(switchButton.textContent=currentTheme=="dark"?"Light theme":"Dark theme")}function switchTheme(){currentTheme=="dark"?(localStorage.setItem(STORAGE_KEY,"light"),document.documentElement.setAttribute("data-theme","light"),currentTheme="light"):(localStorage.setItem(STORAGE_KEY,"dark"),document.documentElement.setAttribute("data-theme","dark"),currentTheme="dark"),changeButtonText()}function showContent(){document.body.style.visibility="visible",document.body.style.opacity=1}</script></div><p class="h-card vcard"><a href=http://blog.ylitalot.com/ class="p-name u-url url fn" rel=me>Juha Ylitalo</a>
/
<a class="p-email u-email email" rel=me href=mailto:juha@ylitalot.net>juha@ylitalot.net</a>
<img class=u-photo src=/images/avatar.jpg></p></footer></div></body></html>